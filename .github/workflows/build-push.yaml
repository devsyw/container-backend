name: Build and Push Docker Image

on:
  push:
    branches:
      - main

env:
  REGISTRY: 192.168.2.2:32000
  IMAGE_NAME: backend

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image tag
        id: tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${SHORT_SHA}"

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} .
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Push Docker image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Update K8s manifests
        run: |
          git clone https://x-access-token:${{ secrets.K8S_REPO_TOKEN }}@github.com/devsyw/container-k8s.git
          cd container-k8s
          
          # yq ÏÑ§Ïπò (ÏóÜÏúºÎ©¥)
          which yq || (sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_arm64 && sudo chmod +x /usr/local/bin/yq)
          
          yq e '.backend.image.tag = "${{ steps.tag.outputs.tag }}"' -i apps/container-platform/values.yaml
          
          # Î≥ÄÍ≤Ω ÌôïÏù∏
          cat apps/container-platform/values.yaml | grep -A 3 "backend:"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git diff --staged --quiet || git commit -m "chore: update backend image to ${{ steps.tag.outputs.tag }}"
          git push origin main

      - name: Output image info
        run: |
          echo "‚úÖ Image pushed successfully!"
          echo "üì¶ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"